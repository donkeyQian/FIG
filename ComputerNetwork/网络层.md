## 概述

网络层的主要作用是实现网络互连，进而实现数据报在各网络间的传输。
因特网(Internet)是目前全世界用户数量最多的互联网，它使用TCP/IP协议栈。由于TCP/IP协议栈的网络层使用网际协议IP,它是整个协议栈的核心协议，因此在TCP/IP协议栈中网络层常称为网际层。
综上所述，`我们通过学习TCP/P协议栈的网际层来学习网络层的理论知识和实践技术。
![](Pasted%20image%2020221204183049.png)

要实现网络互连，就要解决以下三个问题：
1.  网络层向运输层`提供怎样的服务`（“[可靠传输](数据链路层.md#几种可靠传输的实现机制)”还是“不可靠传输”）
	可靠传输：发送方发送什么，接收方就能原原本本的收到什么；需要网络层自己解决传输过程中受到的误码、丢包、乱序的干扰
2.  网络层`寻址问题`
	![](Pasted%20image%2020221204170246.png)

3.  `路由选择问题`

## 网络层提供的两种服务

### 面向连接的虚电路服务

虚电路并不是物理电路，而是在已有网络中构建一条虚拟的电路，和之前学过的电路交换有本质的区别。

![](Pasted%20image%2020221204170351.png)

### 无连接的数据报服务
![](Pasted%20image%2020221204170406.png)

### 两者之间的比较

![](Pasted%20image%2020221204170419.png)

## IPv4地址概述

IPv4 地址就是给因特网上的每一台主机（或路由器）的每一个接口划分一个`全球唯一的32比特标识符`。

32比特的IPv4地址不方便阅读、记录以及输入等，因此IPv4地址采用点分十进制表示方法以方便用户使用。

### IPv4地址分类

IP 地址共分为五类，区分方式为`网络号长度和网络号开头`，其中只有A、B、C三类地址可以分配给网络中的主机和路由器接口。

* 判断一个IP地址的类型可以通过观察第一个十进制数的大小，小于127 的为A类地址， 128 ~ 191 的为B类地址，192~223 的为 C 类地址。

![](Pasted%20image%2020221204170448.png)

#### 特殊的IP地址

* 每个网络中的最小主机号 0 保留为网络号，不指派；
* 最大的主机号（全为1）为广播地址，不指派。
* 根据以上两条可以计算出：一个 A 类网络中可分配 2<sup>24</sup> - 2 = 16777214 个IP 地址，一个 B 类网络中可分配 2<sup>16</sup> - 2 = 65534 个IP 地址，以此类推，C 类网络可分配主机数为 254。
*  以 127 开头且后三个字节非 全0 或 全1 的IP地址时一类特殊的 IPv4 地址，既可以作为源地址使用，也可以作为目的地址使用，用于本地软件环回测试，例如常用的环回测试一直 127.0.0.1
- 0.0.0.0 ： 只能作为源地址使用，表示“在本网络上的本主机”。封装 DHCP Discovery 报文的IP分组的源地址使用 0.0.0.0
- 255.255.255.255 是一个特殊的 IPv4 地址，只能作为目的地址使用，表示只在本网络内进行广播（路由器均不转发）

![](Pasted%20image%2020221204171007.png)

### 划分子网的IPv4地址

三类网络中可分配主机数差距极大，并且网络中可分配的主机数是在设计的时候就定好的，如果需要新增一个独立的网络，需要再重新申请一个网络就很麻烦了。

为新增网络申请新的网络号会带来以下弊端：
1. 需要等待时间和花费更多的费用
2. 会增加其他路由器中路由表记录的数量
3. 浪费原有网络中剩余的大量P地址

因此，现实中一般使用`=子网掩码`来将一个大的主网络划分成几个小的子网络。

32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号：
1. 子网掩码使用`连续的比特1来对应网络号和子网号`
2. 子网掩码使用`连续的比特0来对应主机号`
3. 将划分子网的1PV4地址与其相应的子网掩码进行逻辑与运算就可得到IPV4地址所在子网的网络地址

![](Pasted%20image%2020221204183444.png)  

#### 默认子网掩码

默认子网掩码是指在`未划分子网的情况下`使用的子网掩码

例如：A 类地址的默认子网掩码为 255.0.0.0，B 类地址的默认子网掩码为 255.255.255.0

### 无分类编址的IPv4地址

* 划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的P地址仍在加速消耗，整个PV4地址空间面临全部耗尽的威胁。
* 为此，因特网工程任务组ETF又提出了采用无分类编址的方法来解决P地址紧张的问题，同时还专门成立PV6工作组负责研究新版本P以彻底解决IP地址耗尽问题。
* 1993年，IETF发布了无分类域间路由选择CIDR(Classless Inter-Domain Routing)的RFC文档：*RFC1517~1519*和1520。
    `CIDR消除了传统的A类、B类和C类地址，以及划分子网的概念；
    CIDR可以更加有效地分配IPV4的地址空间`，并且可以在新的Pv6使用之前允许因特网
    的规模继续增长。

例如：192.168.21.10 这个C类地址，用 CIDR 编址的方式表示就是 192.168.21.10/24。

#### 路由聚合（构造超网）

路由聚合的作用是将路由器`路由表中网络号前缀相同的条目合并成一条聚合路由`，缩小路由表，加快查表速度。

当路由表中有多个条目符合路由信息时，路由器会选择网络前缀最长的那条，这称为`最长前缀匹配`，因为这样的路由更具体。

![将四条记录聚合成一个聚合地址块](Pasted%20image%2020221204184339.png)


### IPv4地址的应用规划

给定一个网络块，如何将其划分为更小的地址块？

一般有两种方法：
1.  采用定长的子网掩码 FLSM
2.  采用变长的子网掩码 VLSM

#### FLSM（Fixed Length Subnet Mask）

从主机号中借用几位作为子网掩码，这部分借用的子网掩码尾数固定，因此这种方式分出来的子网数量固定为 2 的 n 次方，n 为借用的位数。

采用 FLSM 划分子网需要提前衡量子网所需求的IP地址数量和子网数量，决定一个合理的借用位数，而且 FLSM 每个子网的可划分IP 数量一致，容易造成IP地址的浪费。

![](Pasted%20image%2020221204171217.png)

#### VLSM（Variable Length Subnet Mask）

计算子网络需要的IP地址数量时，不能随意选取，要保证子网络IP 地址数量为整数倍（2进制）。

![](Pasted%20image%2020221204171225.png)

## 主机间的通信

主机间的通信分为两种方式：一种是双方都在`同一个网段内`，这种称为`直接通信`，通过交换机转发数据帧即可。另一种是双方`不在同一个网络`的情况，则需要通过网关（一般为路由器）转发分组，这种方式被称为`间接通信`。

### 直接通信

主机在给其他主机发送数据时，首先要判断目标主机是否与自己处在同一网段内，如果是同一网段内的主机，则无需通过路由器转发，直接将数据帧交给交换机即可，交换机转发数据帧过程见[[数据链路层#交换机自学习和转发帧的流程]]

* 源主机怎么判断目的主机是否与自己处在同一网络内？
    源主机将自己的网络地址和子网掩码进行与操作，得到自己的网络号，并将目的主机的网络地址与自己的子网掩码进行与操作得出目的网络地址，判断两者是否相同，相同则在同一网络内，不同则不在。

### 间接通信

* 如果要与和自己不在同一网络中的主机通信，源主机会将数据帧发送给局域网中的默认网关，让网关来帮助自己转发分组。

* 网关通常是路由器，默认网关的配置方式有两种，一种是手动配置静态网络，另一种是通过DHCP服务配置。

* 路由器在收到分组后：
1. 首先会检查数据帧中的目标MAC地址，如果这个帧不是发送给自己的，丢弃，否则接收，解封装
	* 对于目的地址是广播地址的数据报，路由器进行转发。 ^2a9faa
1. 根据数据报中首部的[首部检验码](网络层#^626159)对IP数据报的首部`检错`
	* 如果IP数据报首部在传输过程中`误码`，那么路由器会`丢弃`该分组并以[ICMP差错控制报文](网络层#ICMP%20差错报告报文)的形式通告源主机；
	* 如果`目标网络不可达`，路由器也会`丢弃`该分组并以ICMP差错控制报文的形式通告源主机；
2. 再`查表（路由表）转发`
	* 路由器转发分组时，需要将被解封的IP数据报`重新封装成数据帧`，将源MAC地址修改为自己的MAC地址，将目标MAC 地址修改为下一跳的MAC地址，如果下一跳的MAC地址是未知状态，则通过[[数据链路层#ARP协议]]获取下一跳的MAC地址。 

`路由表的配置`和`路由选择协议`是学习网络层的半壁江山，有空要多回来看看。

#### ACL

ACL（Access Control List）是一种包过滤技术，可以根据数据报的首部、TCP/UDP 报文的首部对包进行过滤，可以在路由器上配置，也可以在防火墙上配置（策略）。

ACL 分为 `标准ACL` 和 `拓展 ACL`。

* 标准ACL：
	* 表号：1-99
	* 特点：`只能基于源IP对包进行过滤`


* 拓展ACL：
	* 表号：100-199
	* 特点：可以根据数据报的`源IP、目的IP、端口号和协议等`对包进行过滤

* ACL 规则：
	* ACL表必须应用到路由器的进或者出接口才会生效
	* 一个接口的一个方向只能应用一张表
	* ACL表中的每一条都`由条件和动作组成`，条件满足则执行动作，且严格从上到下检查每一条，当流量不完全满足某一个条件时，ACL 会检查下一个条件，直到流量满足某个条件或到达列表的末尾时丢弃

### 静态路由配置

* 静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表。
    这种人工配置方式`简单、开销小。但不能及时适应网络状态（流量、拓扑等）的变化。
    一般只在小规模网络中采用。

* 路由条目的类型有如下几种
    1. 直连网络
    2. 静态路由（人工配置）
    3. 动态路由（路由选择协议）

* 特殊的静态路由条目：
    1. 默认路由（目的网络为0.0.0.0，地址掩码为0.0.0.0）
    2. 特定主机路由(目的网络为特定主机的IP地址，地址掩码为255.255.255.255)
    3. 黑洞路由（下一跳为nul0 )

#### 静态路由举例说明

![](Pasted%20image%2020221204171913.png)

以上图的网络拓扑结构为例，网络 192.168.2.0/24 对于路由器 R1 来说是未知状态，如果想要与该网络的主机通信，我们可以在R1 的路由表中手动添加一条 192.168.2.0/24 的静态路由配置。

![](Pasted%20image%2020221204171923.png)

同理，如果R1 想连通互联网，那么可以往 R1 的路由表中添加一条默认路由配置 0.0.0.0/0。

#### 静态路由可能导致的路由环路问题

以下几种配置静态路由中出现的问题可能会导致出现`路由环路`
1. 配置错误
2. 聚合了不存在的网络
3. 网络故障

##### 配置错误

已下图为例，10.0.0.0/30 中的主机想与192.168.1.0/24 网络下的主机通信，其将数据报发送给默认网关，R2 的 10.0.1.2 接口，但是由于 R2 的路由表配置错误，这条数据报会在 R2 及 R3 之间循环发送，形成一个路由环路。

![](Pasted%20image%2020221204171939.png)

为了`防止IP 数据报在路由环路中永久兜圈`，在IP 数据报首部设有`生存时间 TTL 字段`。IP数据报在进入路由器后，TTL 字段值减去1，若数据报的 TTL 的值不等于 0，则被路由器转发，否则被丢弃。

##### 聚合了不存在的网络

![](Pasted%20image%2020221204171954.png)

以上图为例，R2 的路由表中除了直接得出的路由信息外，还被添加了一条静态聚合路由，该聚合路由由网络 192.168.1.0/24 和 192.168.2.0/24 聚合而成，当R2 收到一个目的网络为 192.168.3.0/24 的数据报后，R2 根据这条聚合路由错误的将数据报转发给了R1，R1 又根据默认路由转发给R2，这样，该数据报在R1 和R2之间形成了一个路由环路。

解决这个问题的方式是在R2 路由表中添加两条`路由黑洞`，将两个不存在的网络下一条设置为 Null0。

![](Pasted%20image%2020221204172014.png)

这样，R2 在收到目的网络为这两个不存在的网络的数据报时，就会直接丢弃该数据报。

##### 网络故障

![](Pasted%20image%2020221204172026.png)

以上图为例，R1 的 0 号接口由于网络故障无法连通 192.168.1.0/24 这个网络，因此，R1 自动删除了该网络的路由记录。当 R2 收到目的网络为该故障网络的数据报时，由于静态聚合路由记录，R2 会将该数据报转发给路由器 R1，R1 根据默认路由将该数据报转发给R2，这样，在R1 和R2 之间就形成了一个路由环路。

针对这种情况，我们可以在R1 的路由表中添加一条故障网路的黑洞路由，丢弃目的网络为该故障网络的数据报。

### 路由选择协议概述

* 静态路由选择
    由人工配置的网络路由，默认路由，特定主机路由，黑洞路由都属于静态路由。
    优缺点：配置方式简单、开销小。但是不能及时适应网络状态（流量、拓扑）的变化。
    使用场景：适用于小型网络。

*  `动态路由选择`
    路由器通过路由选择协议自动获取路由信息。
    优缺点：`比较复杂、开销比较大。优点是能更好的适应网络状态的变化`。
    使用场景：适用于大规模网络。

#### 因特网所采用的路由选择协议的主要特点

![](Pasted%20image%2020221204172155.png)

***如何理解路由选择协议的分层次？***

因特网采用的路由选择协议将整个因特网划分为许多的小的自治系统AS，每个AS 内部的路由选择协议可以不同，AS 之间采用的路由选择协议也可以不同。

![](Pasted%20image%2020221204172208.png)

#### 常见的路由选择协议

![](Pasted%20image%2020221204172221.png)

#### 路由器的基本结构

![](Pasted%20image%2020221204172227.png)

* 输入缓冲区
    暂存已经输入还没有来得及处理的分组

* 输出缓冲区
    暂存已经处理完毕还没有来得及输出的分组

* 路由表和转发表
    1.  路由表一般仅包含从目的网络到下一跳的映射
    2.  路由表需要对网络拓扑结构变化的计算最优化
    3.  转发表是从路由表得出的
    4.  转发表的结构应当使查找过程最优化

* 路由选择处理机
    1.  处理收到的报文（数据分组和路由报文）
    2.  周期性地向其他路由器发送自己所知道的路由信息

### 路由选择协议RIP的基本工作原理

* `路由信息协议RIP`(Routing Information Protocol))是内部网关协议IGP中最先得到广泛使用的协议之一，其相关标准文档为*RFC1058*。

* RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“`距离向量D-V(Distance-Vector)`”。

* RIP使用`跳数`(Hop Count))作为度量(Metric)来`衡量到达目的网络的距离。`
    * 路由器到直连网络的距离定义为1。
    * 路由器到非直连网络的距离定义为所经过的路由器数加1。
    * 允许一条路径最 多只能包含15个路由器。`“距离”等于16时相当于不可达`。因此，`RIP只适用于小型互联网`
![](Pasted%20image%2020221204185130.png)

* RIP认为`好的路由`就是“距离短”的路由，也就是`所通过路由器数量最少的路由`。

* 当到达同一目的网络有多条“距离相等”的路由时，可以进行`等价负载均衡

* RIP包含以下三个要点：
    `和谁交换信息？` 仅和`相邻路由器`交换信息
    `交换什么信息？` 自己的`路由表`
    `何时交换信息？` `周期性交换`（例如每30秒）
![](Pasted%20image%2020221204185323.png)

![](Pasted%20image%2020221204172347.png)

#### RIP路由条目的更新规则

1. 先对相邻路由器发送的路由信息 进行改造，将它改造成对自己有用的路由信息
    * 将下一跳改成源路由器，距离全部 +1
2. 目的网络已经在路由表中`存在`的
    -   相同下一跳
        -   最新消息：更新
    -   不同下一跳
        -   距离更短，更新
        -   距离相同，添加，等价负载均衡
        -   距离更长，不更新
3. 目的网络在路由表中`不存在`的
    -   添加到路由表中
![](Pasted%20image%2020221204172527.png)

#### RIP存在“坏消息传播得慢”的问题

* “坏消息传播得慢”又称为`路由环路`或`距离无穷计数`问题，这是距离向量算法的一个固有问题。可以采取多种措施`减少`出现该问题的概率或减小该问题带来的危害。
    * `限制最大路径距离`为15 (16表示不可达)
    * 当路由表`发生变化时就立即发送更新报文`（即“触发更新”），而不仅是周期性发送
    * 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送(即“水平分割”) 

R1 连接 N1 的端口故障，该路由信息没有及时传播给R2，在后续的交换信息过程中，该信息反而被R2 的路由记录给覆盖了，因此，在R1 和 R2 间形成了路由环路。
![](Pasted%20image%2020221204185800.png)

### 开放最短路径优先OSPF

#### 概述

* `开放最短路径优先`OSPF(Open Shortest Path First),是为克服RIP的缺点在1989年开发出来的
    “开放”表明OSPF协议不是受某一家厂商控制，而是公开发表的。
    “最短路径优先”是因为使用了Dijkstra提出的`最短路径算法SPF`。

* OSPF是基于链路状态的，而不像RIP那样是基于距离向量的。
* OSPF采用SPF算法计算路由，从算法上保证了`不会产生路由环路`。
* OSPF`不限制网络规模，更新效率高，收敛速度快`。
* 链路状态是指本路由器都和哪些路由器相邻，以及相应链路的“代价”(cost)。
    “代价”用来表示费用、距离、时延、带宽，等等。这些都`由网络管理人员来决定`。
        举例：思科路由器默认代价计算方式为 100Mbps / 链路带宽

#### 基本工作过程

OSPF 的工作过程大致分为以下三步：
    1. 建立和维护邻居关系
    2. 链路状态数据库同步
    3. 路由表发生改变时同步数据库信息

![](Pasted%20image%2020221204172701.png)

##### 建立和维护邻居关系

OSPF 相邻路由器之间通过交互`问候（Hello）分组`，建立和维护邻居关系。
问候分组的细节如下：
    1. Hello 分组封装在IP 数据报中，发往组播地址 224.0.0.5
    2. 发送周期为10秒
    3. 40 秒内未收到来自邻居路由器的Hello 分组，则认为该邻居路由器不可达
![](Pasted%20image%2020221204221128.png)

建立起邻居表后，路由器之间会给邻居发送`链路状态通告LSA，同步链路情况`。
LSA 中包含以下内容：
    1. 直连网络的链路状态信息
    2. 邻居路由器的链路状态信息
![](Pasted%20image%2020221204221151.png)

##### 链路状态数据库同步

使用 OSPF 的每个路由器都有一个链路状态数据库LSDB，用于存储LSA
通过各路由器`洪泛发送` 封装有各自LSA 的LSU 分组，`各路由器的LSDB 最终将达到一致`。
各路由器会`基于LSDB 进行最短路径优先SPF 计算`，构建出各自到达其他路由器的最短路径，即构建各自的路由表。

![](Pasted%20image%2020221204221400.png)

##### 路由表发生改变时同步数据库信息

当链路状态信息发生改变时，路由器会向链路中发送更改后的LSA，同步路由信息。最终链路上的所有使用OSPF算法的路由器的 LSDB 再次达成一致，重新基于各自的LSDB 构造路由表。

#### OSPF 的分组类型

OSPF有以下五种分组类型：
    1. `问候`（Hello）分组
        用来发现和维护邻居路由器的可达性。
    2. `数据库描述`(Database Description）分组
        向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息
    3. `链路状态请求`(Link State Request) 分组
        向邻居路由器请求发送某些链路状态项目的详细信息。
    4. `链路状态更新`(Link State Update）分组
        路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态。
    5. `链路状态确认`(Link State Acknowledgment) 分组
        这是对链路状态更新分组的确认分组。

#### 多点接入网络中的邻居关系建立

在多点接入网络中，使用 OSPF 算法的路由器需要维护大量的邻居，随着邻居的增多，同步链路状态所需要花费的资源也就更多，网络利用率也会随之下降。
![](Pasted%20image%2020221204222404.png)

为了解决以上问题，采用 OSPF 算法的多点接入网络一般会`选举指定路由器DR(designated router)和备用的指定路由器BDR(backup designated router)，所有的非DR/BDR只与DR/BDR建立邻居关系，非DR/BDR之间通过DR/BDR交换信息`

![](Pasted%20image%2020221204222536.png)

#### OSPF在大规模网络中的应用

OSPF 在发送 LSA 时，相邻路由器会洪泛地进行转发，最终使网络中的所有路由器的路由信息数据库一致。这种做法在大型网络中会造成广播风暴，通信资源的浪费。

为了使OSPF能够用于规模很大的网络，OSPF 把一个自治系统再划分成若干个更小的范围，叫做区域（Area）。每个区域的范围不应太大，一般所包含的路由器小于200个，划分区域的好处就是将洪泛法交换链路状态信息的范围局限在区域内而不是整个自治系统，这样就减少了整个网络上的通信量。

每个区域都由一个32位的二进制区域标识符标识。其中，用于连通其他区域的网络称为主干区域，主干区域的区域标识符为 0.0.0.0，其他区域的标识符不能为0且互不相同。

![](Pasted%20image%2020221204172726.png)

### 外部网关协议BGP的基本工作原理

外部网关协议EGP（例如边界网关协议BGP）
    在不同的自治系统内，度量路由的代价（举例、带宽、费用等）可能不同
    自治系统之间的路由选择必须考虑相关策略（政治、经济、安全等）
    基于上述的考虑，BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），并非是寻找一条最佳路径

* 在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的“`BGP发言人`”
不同自治系统的BGP发言人要交换路由信息，首先必须建立`TCP连接，端口号为179`
    在此TCP连接上交换BGP报文以建立BGP会话
    利用BGP会话`交换路由信息`（例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等）
    使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的`邻站`(neighbor）或`对等站`（peer)

* BGP发言人除了运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP，例如OSPF或RIP。

* BGP发言人互相`交换网络可达性的信息`（要到达某个网络所要经过的一系列自治系统）

* 当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就`根据`所采用的`策略`从收到的路由信息中`找出到达各自治系统的较好的路由`。也就是构造出树形结构、`不存在回路的自治系统连通图`。

* BGP适用于多级结构的因特网

* BGP-4有以下四种报文
    1. `OPEN(打开)报文`：用来与相邻的另一个BGP发言人建立关系，使通信初始化。
    2. `UPDATE(更新)报文`：用来通告某一路由的信息，以及列出要撤销的多条路由。
    3. `KEEPALIVE(保活)报文`：用来周期性地证实邻站的连通性。
    4. `NOTIFICATION(通知)报文`：用来发送检测到的差错。

## IPv4数据报的首部格式

![](Pasted%20image%2020221204172806.png)

* 版本
    `表示IP协议的版本`。通信双方使用的IP协议必须一致。目前广泛使用的IP 协议版本号为 4 （即 IPv4）

* 首部长度
    占4比特，`表示IP 数据报首部的长度`。该字段的取值以4字节为单位，IP数据报的首部长度必须为4 的倍数。
    最小取值为101，表示首部只有固定部分 20 个字节（5 * 4）
    最大取值为1111，表示首部长度为 15 * 4 = 60 Byte

* 可变字段
    长度从1个字节到40个字节不等。用来支持排错、测量及安全等措施

* 填充字段  
    用来保证IP 数据报首部的长度为 4 的整数倍，用全 0 进行填充

* 区分服务
    用来获得更好的服务。
    利用改字段的不同数值获取不同等级的服务质量
    只有在使用区分服务时，才使用该字段，一般情况下很少使用

* 总长度
    表示IP数据报的总长度（首部 + 数据部分）
    最大取值为十进制 65535，以字节              为单位

* `标识、标志、页偏移`
    这三个字段共同`作用于IP 数据报的分片`；IP 数据报封装后，需要在数据链路层封装成帧，但是不同的数据链路层协议规定了不同的 MTU（最大传输单元），例如以太网协议的 MTU 规定为 1500 Byte，如果数据报的长度超出了MTU 的规定大小，那么 IP 数据报就要进行分片传输。
    
    现实中经常有攻击者通过生成假分片IP数据报攻击靶机，使靶机的网络层疲于重组分片，这也是一种DDOS攻击的形式。因此，现如今的大部分防火墙都开启了不允许分片数据报通过的功能。大多数应用层软件也能适应这种变化，让数据传输部分的分片在应用层进行，不再交给网络层。
    
    -   标识
        -   占16比特，属于同一个数据报的各分片数据报应该具有一个相同的标识。IP 软件维持一个计数器，每产生一个数据报，计数器值增加1，并将此值赋值给标识字段。
    
    -   标志
        -   占 3 比特，各比特含义如下：
            - 保留位：必须为 0
            - DF 位：1 表示不允许分片；0 表示允许分片
            - MF 位：1 表示“后面还有分片”；0 表示“这是最后一个分片”
    
    -   片偏移
        -   占 13 比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。片偏移以 8个字节为单位。

* 生存时间 TTL
    以跳数为单位，路由器转发IP 数据报时，将TTL 减一，若不为 0 则转发，否则丢弃。

* 协议
    占 8 比特，指明 IP 数据报的数据部分是何种协议数据单元
    常见的协议及其字段值
| 协议名称   | ICMP | IGMP | TCP | UDP | IPv6 | OSPF |
| ---------- | ---- | ---- | --- | --- | ---- | ---- |
| 协议字段值 | 1    | 2    | 6   | 17  | 41   | 89   |
 ^ccc8a4
 
* 首部检验码
    占16 比特，用于检验首部在传输过程中是否出现差错。比CRC检验码简单，称为因特网检验和。 ^626159

## 网际控制报文协议ICMP

为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP（Internet Control Message Protocol）。

ICMP 报文被封装在IP 数据报中发送，没有常用端口号。

ICMP协议的作用：
1. 网络探测
2. 路由跟踪
3. 错误反馈

主机和路由器使用 ICMP 协议发送`差错报告报文`和`询问报文`。

### ICMP 差错报告报文

共分为以下五种：

1.  `终点不可达`
    当路由器或主机不能交付数据时，就像源点发送终点不可达报文，具体可以再根据 ICMP 的代码字段分为目的网络不可达，目的主机不可达、目的端口不可达、目的网络不可达、目的主机未知等13种错误。

2.  `源点抑制`
    当路由器或主机由于拥塞而丢弃数据时，就像源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。![](Pasted%20image%2020221204181544.png)

3.  `时间超过`
    当路由器收到一个目的IP 地址不是自己的IP数据报，会将其生存时间TTL字段的值减1。
    若结果不为0，则将该IP数据报转发出去；若结果为0，除丢弃该IP数据报外，还要向源点发送时间超过报文。
    另外，当终点在预先规定的时间内不能收到一个数据包的全部数据包片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文。

4.  `参数问题`
    当路由器或目的主机收到IP 数据报后，根据其首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文![](Pasted%20image%2020221204180942.png)

5.  `改变路由（重定向）`
    路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由器（可通过更好的路由）![](Pasted%20image%2020221204181712.png)

#### 以下情况不应发送ICMP差错报告报文

1. 对ICMP差错报告报文不再发送ICMP差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
3. 对`具有多播地址的数据报都不发送`ICMP差错报告报文
4. 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文

### ICMP询问报文

常用的ICMP询问报文有以下两种：

1. `回送请求和回答`
    ICMP 回送请求报文是由主机或路由器向一个特定的目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。
    这种询问报文用来测试目的站是否可达及了解其有关状态。
2. `时间戳请求和回答`
    ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。
    这种询问报文用来进行时钟同步和测量时间。

### ICMP应用举例

#### 分组网间探测PING（Packet Internet Groper）

* 作用
    1. 用来测试主机或路由器间的连通性
    2. 应用层直接使用网际层的ICMP(没有通过运输层的TCP或UDP)
    3. 使用ICMP回送请求和回答报文
    
![](https://cdn.nlark.com/yuque/0/2022/png/22363114/1669722710331-443e7b4b-f1e0-405f-b5b0-8bc396815fec.png)

#### 跟踪路由traceroute

* 作用
    1. 用来测试数据报从源主机到达目的主机要经过哪些路由器

1. Windows 版本 
        1. tracert命令
        2. 应用层直接使用网际层ICMP
        3. 使用了ICMP回送请求和回答报文以及差错报告报文
2. Unix版本
        1. traceroute命令
        2. 在运输层使用UDP协议
        3. 仅使用ICMP差错报告报文
        
![](https://cdn.nlark.com/yuque/0/2022/png/22363114/1669723118799-0b846162-be89-44e5-9472-2dde513260c5.png)

该功能的原理是发送 TTL 从 1 开始**递增**的目的地址为探测地址的IP数据报，这样，路径上的每一跳都会给源地址发送ICMP差错报告报文。

## 虚拟专用网VPN与网络地址转换NAT

### 虚拟专用网VPN（Virtual Private Network）

在现实世界中，我们如何让在两个城市中的不同机构互相通信？第一个方案是在两地之间架设线路，实现信息联通，第二个方案是`利用公用的因特网`，`作为`机构之间`专用网的通信载体`，这样的专用网又称为`虚拟专用网`。

`VPN 的类型`分为以下两种：
1. 远程访问VPN（一般用于个人到企业的安全连接）
2. 点到点VPN（一般用于企业间的安全连接）

远程访问 VPN 一般由企业架设VPN 服务器，个人拨号连接VPN服务，常见的远程访问VPN协议有：SSL-VPN协议、PPTP VPN协议、L2TP VPN 协议。常见的点到点VPN 协议有：IPsecVPN。

IPsecVPN 分为两个阶段：
1. 管理连接
	1. 通信双方通过非对称加密协商数据连接阶段使用的秘钥。
2. 数据连接
	1. 这一阶段使用对称加密的策略对数据进行加密并传输。

由于 IPv4 地址的数量紧张，一个机构所能申请的IPv4 地址往往远少于机构内的主机数量，因此，机构内使用的IPv4 地址应该是本机构可自由支配的专用地址，而不是需要申请、在因特网上使用的公网地址。

IPv4 申请机构提供了三个`可自行分配的专用网地址`：
1. 10.0.0.0~10.255.255.255(10/8地址块)
2. 172.16.0.0~172.31.255.255 (172.16/16 - 172.31/16)
3. 192.168.0.0~192.168.255.255(192.168/16地址块)


#### VPN 通信流程概述

1. 部门 A 的主机发送 目的地址为 10.2.0.3 的数据报
2. R1 收到该数据报后，对数据报进行加密然后对信息进行二次封装，带上带有 公网 IP 的IP 数据报首部
3. R2 收到 R1 发送的数据报后，先对数据报进行解封，然后再解密
4. R2 将解密之后的数据报发送给 10.2.0.3 的主机

![](https://cdn.nlark.com/yuque/0/2022/png/22363114/1669723908285-ae859aff-27eb-41e3-8001-62658e35d153.png)

### 网络地址转换 NAT（Network Address Translation）

虽然因特网采用了无分类编址方式来减缓IPv4地址空间耗尽的速度，但由于因特网用户数目的
激增，特别是大量小型办公室网络和家庭网络接入因特网的需求不断增加，IPv4地址空间即将面临耗尽的危险仍然没有被解除。  

1994年提出了一种网络地址转换NAT的方法再次`缓解了IPv4地址空间即将耗尽的问题`。

NAT能使大量`使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机`
和资源。

NAT 的具体做法就是路由器将公网 IP 地址与专用网下的主机 IP 对应。当专用网内的主机需要与公网上的主机通信时，路由器会将该主机与一个公网IP 对应，并在路由器内维护一个 内网地址与外网地址的映射表，当专用网内的主机需要接收来自公网的数据报时，路由器会先查找映射表，找到正在使用目的IP 的专用网主机，将数据报转发。

![](Pasted%20image%2020221204225517.png)

#### NAPT

由于绝大多数的网络应用都是使用运输层协议TCP或UDP来传送数据，因此可以利用运输层的端口号和IP地址一起进行转换。
这样，`用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信`。这种将端口号和IP地址一起进行转换的技术叫作`网络地址与端口号转换NAPT`(Network Address and Port Translation)。

路由器在转发数据报时，为了防止内网主机在访问同一外网IP时使用了相同的端口号，会在转发分组时将源端口号修改为路由器的随机端口号。

![](Pasted%20image%2020221204225711.png)